<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.techsupportscheduler.support.dao.NoticeDao">

    <!-- 목록 -->
    <select id="doList" resultType="com.boot.techsupportscheduler.support.vo.Notice">
        SELECT
        notice_id      AS noticeId,
        is_top         AS isTop,
        title          AS title,
        writer         AS writer,
        writer_user_id AS writerUserId,
        content        AS content,
        views          AS views,
        created_at     AS createdAt,
        updated_at     AS updatedAt,
        deleted_yn     AS deleteYn,
        deleted_at     AS deletedAt
        FROM notice
        WHERE deleted_yn = 'N'
        ORDER BY is_top DESC, notice_id DESC
    </select>

    <!-- 상세 1건 -->
    <select id="doDetail" parameterType="long" resultType="com.boot.techsupportscheduler.support.vo.Notice">
        SELECT
        notice_id      AS noticeId,
        is_top         AS isTop,
        title          AS title,
        writer         AS writer,
        writer_user_id AS writerUserId,
        content        AS content,
        views          AS views,
        created_at     AS createdAt,
        updated_at     AS updatedAt,
        deleted_yn     AS deleteYn,
        deleted_at     AS deletedAt
        FROM notice
        WHERE notice_id = #{noticeId}
        AND deleted_yn = 'N'
    </select>

    <!-- 이전글 -->
    <select id="doPrev" parameterType="long" resultType="com.boot.techsupportscheduler.support.vo.Notice">
        SELECT
        notice_id AS noticeId,
        title     AS title
        FROM notice
        WHERE deleted_yn = 'N'
        AND notice_id &lt; #{noticeId}
        ORDER BY notice_id DESC
        LIMIT 1
    </select>

    <!-- 다음글 -->
    <select id="doNext" parameterType="long" resultType="com.boot.techsupportscheduler.support.vo.Notice">
        SELECT
        notice_id AS noticeId,
        title     AS title
        FROM notice
        WHERE deleted_yn = 'N'
        AND notice_id &gt; #{noticeId}
        ORDER BY notice_id ASC
        LIMIT 1
    </select>

    <!-- 1)countSearch (전체 글 개수 세기)-->
    <select id="countSearch" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM notice
        WHERE deleted_yn = 'N'

        <if test="topOnly != null and topOnly != '' and topOnly == '1'">
            AND is_top = 1
        </if>

        <if test="q != null and q != ''">
            <choose>
                <when test="field == 'title'">
                    AND title LIKE CONCAT('%', #{q}, '%')
                </when>
                <when test="field == 'content'">
                    AND content LIKE CONCAT('%', #{q}, '%')
                </when>
                <when test="field == 'writer'">
                    AND writer LIKE CONCAT('%', #{q}, '%')
                </when>
                <otherwise>
                    AND (
                    title LIKE CONCAT('%', #{q}, '%')
                    OR content LIKE CONCAT('%', #{q}, '%')
                    OR writer LIKE CONCAT('%', #{q}, '%')
                    )
                </otherwise>
            </choose>
        </if>
    </select>

    <!-- ✅ 2) 현재 페이지 목록 검색 -->
    <select id="searchPaged" parameterType="map" resultType="com.boot.techsupportscheduler.support.vo.Notice">
        SELECT notice_id, is_top, title, writer, writer_user_id, content, views,
        created_at, updated_at, deleted_yn, deleted_at
        FROM notice
        WHERE deleted_yn = 'N'

        <if test="topOnly != null and topOnly != '' and topOnly == '1'">
            AND is_top = 1
        </if>

        <if test="q != null and q != ''">
            <choose>
                <when test="field == 'title'">
                    AND title LIKE CONCAT('%', #{q}, '%')
                </when>
                <when test="field == 'content'">
                    AND content LIKE CONCAT('%', #{q}, '%')
                </when>
                <when test="field == 'writer'">
                    AND writer LIKE CONCAT('%', #{q}, '%')
                </when>
                <otherwise>
                    AND (
                    title LIKE CONCAT('%', #{q}, '%')
                    OR content LIKE CONCAT('%', #{q}, '%')
                    OR writer LIKE CONCAT('%', #{q}, '%')
                    )
                </otherwise>
            </choose>
        </if>

        ORDER BY is_top DESC,
        <choose>
            <when test="sort == 'old'"> notice_id ASC </when>
            <when test="sort == 'views'"> views DESC, notice_id DESC </when>
            <otherwise> notice_id DESC </otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 등록 -->
    <insert id="doInsert"
            parameterType="com.boot.techsupportscheduler.support.vo.Notice"
            useGeneratedKeys="true" keyProperty="noticeId">
        INSERT INTO notice
        (is_top, title, content, views, created_at, updated_at, deleted_yn, deleted_at)
        VALUES
        (#{isTop}, #{title}, #{content}, 0, NOW(), NOW(), 'N', NULL)
    </insert>

    <!-- 조회수 증가 -->
    <update id="increaseViews" parameterType="long">
        UPDATE notice
        SET views = views + 1
        WHERE notice_id = #{noticeId}
        AND deleted_yn = 'N'
    </update>

    <!-- 삭제 -->
    <update id="doDelete" parameterType="long">
        UPDATE notice
        SET deleted_yn = 'Y',
        deleted_at = NOW()
        WHERE notice_id = #{noticeId}
    </update>

    <!-- 수정 -->
    <update id="doUpdate" parameterType="com.boot.techsupportscheduler.support.vo.Notice">
        UPDATE notice
        SET is_top = #{isTop},
        title = #{title},
        content = #{content},
        updated_at = NOW()
        WHERE notice_id = #{noticeId}
        AND deleted_yn = 'N'
    </update>

    <select id="selectCommentList" parameterType="long" resultType="com.boot.techsupportscheduler.support.vo.NoticeComment">
        SELECT
        comment_id   AS commentId,
        notice_id    AS noticeId,
        writer       AS writer,
        content      AS content,
        like_count   AS likeCount,
        created_at   AS createdAt
        FROM notice_comment
        WHERE notice_id = #{noticeId}
        AND deleted_yn = 'N'
        ORDER BY comment_id ASC
    </select>

    <insert id="insertComment" parameterType="com.boot.techsupportscheduler.support.vo.NoticeComment">
        INSERT INTO notice_comment
        (notice_id, writer, content, like_count, created_at, deleted_yn)
        VALUES
        (#{noticeId}, #{writer}, #{content}, 0, NOW(), 'N')
    </insert>

    <update id="increaseLikeCount" parameterType="long">
        UPDATE notice_comment
        SET like_count = like_count + 1
        WHERE comment_id = #{commentId}
    </update>

    <select id="selectLikeCount" parameterType="long" resultType="int">
        SELECT like_count
        FROM notice_comment
        WHERE comment_id = #{commentId}
    </select>

    <!--좋아요 + 및 - 데이터-->
    <select id="checkLikeHistory" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM notice_comment_like
        WHERE comment_id = #{commentId}
        AND user_id = #{loginId}  </select>

    <insert id="insertLikeHistory" parameterType="map">
        INSERT INTO notice_comment_like (comment_id, user_id, created_at)
        VALUES (#{commentId}, #{loginId}, NOW())
    </insert>

    <delete id="deleteLikeHistory" parameterType="map">
        DELETE FROM notice_comment_like
        WHERE comment_id = #{commentId}
        AND user_id = #{loginId}
    </delete>

    <update id="decreaseLikeCount" parameterType="long">
        UPDATE notice_comment
        SET like_count = like_count - 1
        WHERE comment_id = #{commentId}
    </update>

    <select id="selectCommentById" parameterType="long"
            resultType="com.boot.techsupportscheduler.support.vo.NoticeComment">
        SELECT
        comment_id AS commentId,
        notice_id  AS noticeId,
        writer     AS writer,
        content    AS content,
        like_count AS likeCount,
        created_at AS createdAt
        FROM notice_comment
        WHERE comment_id = #{commentId}
        AND deleted_yn = 'N'
        LIMIT 1
    </select>

    <update id="updateCommentContent" parameterType="map">
        UPDATE notice_comment
        SET content = #{content}
        WHERE comment_id = #{commentId}
        AND deleted_yn = 'N'
    </update>

    <update id="softDeleteComment" parameterType="long">
        UPDATE notice_comment
        SET deleted_yn = 'Y'
        WHERE comment_id = #{commentId}
        AND deleted_yn = 'N'
    </update>


</mapper>
