<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.techsupportscheduler.support.dao.SupportDao">

    <!-- 목록 -->
    <select id="doList" resultType="com.boot.techsupportscheduler.support.vo.Support">
        SELECT
        s.ticket_id      AS ticketId,
        s.support_date   AS supportDate,
        s.project_id     AS projectId,
        p.project_name   AS projectName,
        s.support_type   AS supportType,
        s.status         AS status,
        s.title          AS title,
        s.content        AS content,
        s.created_at     AS createdAt,
        s.updated_at     AS updatedAt,
        s.deleted_yn     AS deletedYn,
        s.deleted_at     AS deletedAt
        FROM support s
        LEFT JOIN project p ON p.project_id = s.project_id
        WHERE s.deleted_yn = 'N'
        ORDER BY s.support_date ASC, s.ticket_id ASC
    </select>

    <select id="doDetail" parameterType="long" resultType="com.boot.techsupportscheduler.support.vo.Support">
        SELECT
        s.ticket_id      AS ticketId,
        s.support_date   AS supportDate,
        s.project_id     AS projectId,
        p.project_name   AS projectName,
        s.support_type   AS supportType,
        s.status         AS status,
        s.title          AS title,
        s.content        AS content,
        s.created_at     AS createdAt,
        s.updated_at     AS updatedAt,
        s.deleted_yn     AS deletedYn,
        s.deleted_at     AS deletedAt
        FROM support s
        LEFT JOIN project p ON p.project_id = s.project_id
        WHERE s.ticket_id = #{id}
        AND s.deleted_yn = 'N'
        LIMIT 1
    </select>


    <!-- 등록
            ⚠ ticket_id는 AUTO_INCREMENT 여야 useGeneratedKeys로 PK가 들어옴 -->
    <insert id="doInsert"
            parameterType="com.boot.techsupportscheduler.support.vo.Support"
            useGeneratedKeys="true"
            keyProperty="ticketId">
        INSERT INTO support (
        support_date,
        project_id,
        support_type,
        status,
        title,
        content,
        created_at,
        updated_at,
        deleted_yn
        ) VALUES (
        #{supportDate},
        #{projectId},
        #{supportType},
        IFNULL(#{status}, 'OPEN'),
        #{title},
        #{content},
        NOW(),
        NOW(),
        IFNULL(#{deletedYn}, 'N')
        )
    </insert>



</mapper>
