<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:with="activeMenu='home'">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>대시보드</title>

    <link rel="stylesheet" th:href="@{/css/app.css}"/>

    <script th:src="@{/js/jquery-3.7.1.js}"></script>
    <script th:src="@{/js/jquery.cookie.js}"></script>

    <style>
        /* 검색 바(대시보드용) */
        .search-card{
            margin: 12px 0 14px;
            padding: 14px;
            border: 1px solid rgba(0,0,0,.08);
            border-radius: 14px;
            background: #fff;
        }
        .search-grid{
            display:grid;
            grid-template-columns: 140px 1fr 140px 140px auto;
            gap: 10px;
            align-items:end;
        }
        .search-grid .field{ margin:0; }
        .search-actions{ display:flex; gap:8px; justify-content:flex-end; }

        @media (max-width: 1024px){
            .search-grid{ grid-template-columns: 1fr 1fr; }
            .search-actions{ justify-content:flex-start; }
        }
        @media (max-width: 640px){
            .search-grid{ grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
<div class="app-shell">

    <!-- HEADER -->
    <div th:replace="~{comm/header :: header(activeMenu=${activeMenu})}"></div>

    <!-- CONTENT -->
    <main class="content">
        <section class="board">

            <div class="board-head">
                <h1 class="board-title">공지사항</h1>
                <div class="page-actions">
                    <!-- ✅ ADMIN만 이동 -->
                    <!-- ✅ ADMIN이면 링크 이동 -->
                    <a class="btn btn-primary"
                       th:if="${session.LOGIN_USER != null and session.LOGIN_USER.role == 'ROLE_ADMIN'}"
                       th:href="@{/support/notice/new}">공지 등록</a>

                    <!-- ✅ ADMIN 아니면 토스트만 -->
                    <a class="btn btn-primary"
                       th:unless="${session.LOGIN_USER != null and session.LOGIN_USER.role == 'ROLE_ADMIN'}"
                       href="javascript:void(0);"
                       onclick="toast('공지 등록은 ADMIN만 가능해'); return false;">공지 등록</a>


                </div>
                </div>

            <!-- ✅ 검색 + 정렬 -->
            <div class="search-card">
                <form id="id_fm_menu" th:action="@{/support/notice_search}" method="post">

                    <!-- ✅ 페이징용 hidden (page/size) -->
                    <input type="hidden" name="page" id="page" th:value="${pageInfo != null ? pageInfo.page : 1}">
                    <input type="hidden" name="size" id="size" th:value="${pageInfo != null ? pageInfo.size : 10}">

                    <div class="search-grid">

                        <div class="field">
                            <label class="label">검색 대상</label>
                            <select class="select" name="field">
                                <option value="all" th:selected="${field == null or field == 'all'}">전체</option>
                                <option value="title" th:selected="${field == 'title'}">제목</option>
                                <option value="content" th:selected="${field == 'content'}">내용</option>
                                <option value="writer" th:selected="${field == 'writer'}">작성자</option>
                            </select>
                        </div>

                        <div class="field">
                            <label class="label">검색어</label>
                            <input class="input" type="text" name="q" placeholder="검색어 입력"
                                   th:value="${q}">
                        </div>

                        <div class="field">
                            <label class="label">상단공지</label>
                            <select class="select" name="topOnly">
                                <option value="" th:selected="${topOnly == null or topOnly == ''}">전체</option>
                                <option value="1" th:selected="${topOnly == '1'}">상단만</option>
                            </select>
                        </div>

                        <div class="field">
                            <label class="label">정렬</label>
                            <select class="select" name="sort">
                                <option value="new" th:selected="${sort == null or sort == 'new'}">최신순</option>
                                <option value="old" th:selected="${sort == 'old'}">오래된순</option>
                                <option value="views" th:selected="${sort == 'views'}">조회순</option>
                            </select>
                        </div>

                        <div class="search-actions">
                            <!-- ✅ 검색은 항상 1페이지로 리셋 -->
                            <button type="button" class="btn btn-primary" onclick="goSearch()">검색</button>

                            <!-- ✅ 초기화는 목록으로 -->
                            <a class="btn btn-secondary" th:href="@{/support/notice}">초기화</a>
                        </div>

                    </div>
                </form>
            </div>

            <div class="board-card">
                <div class="table-wrap">
                    <table class="tbl">
                        <thead>
                        <tr>
                            <th style="width:90px;">번호</th>
                            <th>제목</th>
                            <th style="width:160px;">작성일</th>
                            <th style="width:120px;">조회수</th>
                            <th style="width:120px;">관리</th>
                            <th style="width:140px;">작성자</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:if="${#lists.isEmpty(notices)}">
                            <td class="empty" colspan="6">등록된 공지사항이 없습니다.</td>
                        </tr>

                        <tr th:each="n, stat : ${notices}">
                            <!-- ✅ 전체번호로 보이게(페이지네이션 적용 시) -->
                            <td class="t-center"
                                th:text="${pageInfo != null ? pageInfo.offset + stat.index + 1 : stat.count}">1</td>

                            <td class="title-cell">
                                <span th:if="${n.isTop == 1 or n.isTop == '1'}" class="badge badge-top">상단</span>

                                <a th:href="@{/support/notice/detail(noticeId=${n.noticeId})}"
                                   th:text="${n.title}">제목</a>
                            </td>

                            <td class="t-center"
                                th:text="${n.createdAt != null ? #temporals.format(n.createdAt, 'yyyy-MM-dd') : '-'}">
                                2024-05-02
                            </td>

                            <td class="t-center" th:text="${n.views}">5</td>

                            <td class="t-center">
                                <form th:action="@{/support/notice/delete}" method="POST"
                                      onsubmit="return confirm('정말 삭제할까요?');">
                                    <input type="hidden" name="noticeId" th:value="${n.noticeId}">
                                    <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                                </form>
                            </td>

                            <td class="t-center" th:text="${n.writer != null ? n.writer : 'admin'}">admin</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ✅ 동적 페이징 (1페이지여도 항상 보이게) -->
            <div class="pager" th:if="${pageInfo != null}">
                <!-- 맨앞 -->
                <button type="button" class="page-btn"
                        th:disabled="${pageInfo.page == 1 or pageInfo.totalPages == 0}"
                        th:onclick="|goPage(1)|">«</button>

                <!-- 이전 -->
                <button type="button" class="page-btn"
                        th:disabled="${!pageInfo.hasPrev()}"
                        th:onclick="|goPage(${pageInfo.page - 1})|">‹</button>

                <!-- 숫자 버튼 (totalPages가 0이면 sequence가 깨질 수 있어서 1로 보정) -->
                <button type="button" class="page-btn"
                        th:each="p : ${#numbers.sequence(pageInfo.startPage, pageInfo.endPage)}"
                        th:text="${p}"
                        th:classappend="${p == pageInfo.page} ? ' active' : ''"
                        th:disabled="${pageInfo.totalPages <= 1 and p == 1}"
                        th:onclick="|goPage(${p})|">1</button>

                <!-- 다음 -->
                <button type="button" class="page-btn"
                        th:disabled="${!pageInfo.hasNext()}"
                        th:onclick="|goPage(${pageInfo.page + 1})|">›</button>

                <!-- 맨뒤 -->
                <button type="button" class="page-btn"
                        th:disabled="${pageInfo.page == pageInfo.totalPages or pageInfo.totalPages <= 1}"
                        th:onclick="|goPage(${pageInfo.totalPages})|">»</button>
            </div>

        </section>
    </main>

    <!-- FOOTER -->
    <div th:replace="~{comm/footer :: footer}"></div>

</div>

<script>
    function goSearch(){
        document.getElementById('page').value = 1; // 검색은 1페이지부터
        document.getElementById('id_fm_menu').submit();
    }

    function goPage(p){
        document.getElementById('page').value = p; // 페이지 이동
        document.getElementById('id_fm_menu').submit();
    }
</script>

</body>
</html>
